<div class="page-wrap">
  <!-- Switch vista -->
  <div class="view-switch">
    <span class="sr-only" id="view-label">Visualizzazione</span>
    <div class="segmented" role="radiogroup" aria-labelledby="view-label">
      <input type="radio" id="view-month" name="calendarView" [value]="CalendarView.Month" [(ngModel)]="view" />
      <label for="view-month">üóìÔ∏è <span>Mese</span></label>

      <input type="radio" id="view-week" name="calendarView" [value]="CalendarView.Week" [(ngModel)]="view" />
      <label for="view-week">üìÖ <span>Settimana</span></label>

      <input type="radio" id="view-day" name="calendarView" [value]="CalendarView.Day" [(ngModel)]="view" />
      <label for="view-day">üïò <span>Giorno</span></label>
    </div>
  </div>

  <!-- Toolbar calendario -->
  <div class="cal-toolbar">
    <div class="left">
      <button class="btn" (click)="goPrev()">‚Äπ</button>
      <button class="btn" (click)="goToday()">Oggi</button>
      <button class="btn" (click)="goNext()">‚Ä∫</button>
      <span class="current-period">{{ viewDate | date: (view === CalendarView.Month ? 'LLLL y' : (view ===
        CalendarView.Week ? '\'Settimana del\' d MMM y' : 'd MMM y')) }}</span>
    </div>
    <div class="right">
      <label class="status-filter">
        <span>Stato</span>
        <select [(ngModel)]="statusFilter" (ngModelChange)="onStatusFilterChange($event)">
          <option value="ALL">Tutti</option>
          <option value="BOOKED">BOOKED</option>
          <option value="CONFIRMED">CONFIRMED</option>
          <option value="CLOSED">CLOSED</option>
          <option value="CANCELLED">CANCELLED</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Calendario -->
  <div class="calendar-wrap">
    <mwl-calendar-month-view *ngIf="view === CalendarView.Month" [viewDate]="viewDate" [events]="events"
      [refresh]="refresh" (dayClicked)="handleDayClick($event.day.date)"
      (eventClicked)="openEventDetails($event.event)">
    </mwl-calendar-month-view>

    <mwl-calendar-week-view *ngIf="view === CalendarView.Week" [viewDate]="viewDate" [events]="events"
      [refresh]="refresh" (hourSegmentClicked)="onTimeSlotClick($event.date)"
      (eventClicked)="openEventDetails($event.event)">
    </mwl-calendar-week-view>

    <mwl-calendar-day-view *ngIf="view === CalendarView.Day" [viewDate]="viewDate" [events]="events" [refresh]="refresh"
      (hourSegmentClicked)="onTimeSlotClick($event.date)" (eventClicked)="openEventDetails($event.event)">
    </mwl-calendar-day-view>

    <div *ngIf="loading" class="loading">Caricamento appuntamenti‚Ä¶</div>
  </div>
</div>

<!-- === MODALE EVENTO (CREA / MODIFICA) === -->
<div class="modal-overlay" *ngIf="modalVisible" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h2>{{ editingRef ? 'Modifica appuntamento' : 'Nuovo appuntamento' }}</h2>

    <label for="title">Titolo</label>
    <input id="title" [(ngModel)]="modalData.title" />

    <label for="description">Descrizione</label>
    <textarea id="description" rows="3" [(ngModel)]="modalData.description"></textarea>

    <div class="row-2">
      <div>
        <label for="startTime">Ora inizio</label>
        <input id="startTime" type="time" [(ngModel)]="modalData.startTime" />
      </div>
      <div>
        <label for="endTime">Ora fine</label>
        <input id="endTime" type="time" [(ngModel)]="modalData.endTime" />
      </div>
    </div>

    <!-- Paziente -->
    <label for="patientSearch">Paziente</label>
    <div class="user-picker">
      <div #userInputWrap class="user-input-wrap">
        <input id="patientSearch" type="text" placeholder="Cerca nome o email‚Ä¶" [(ngModel)]="userSearch"
          (focus)="openUserList()" (input)="onUserSearchChange(userSearch)" (keydown)="onUserInputKeydown($event)"
          (blur)="closeUserListSoon()" autocomplete="off" />

        <!-- Dropdown risultati -->
        <div class="user-results" *ngIf="userListOpen" [class.open-up]="userListOpenUp"
          [ngStyle]="{ 'max-height.px': userListMaxHeight }">
          <button *ngFor="let p of userResults; let i = index" class="user-option" [class.active]="i === highlightIndex"
            (mousedown)="$event.preventDefault()" (click)="selectPatient(p)">

            <span class="avatar">
              {{ (p.firstname?.[0] || '') + (p.lastname?.[0] || '') || (p.email?.[0] || '?') }}
            </span>

            <span class="meta" style="display:inline-block; padding:2px;">
              <strong>{{ p.firstname || '?' }} {{ p.lastname || '?' }}</strong>
              <small>{{ p.email || 'n/d' }}</small>
              <small>{{ p.SSN || 'CF n/d' }}</small>
            </span>
          </button>

          <div class="empty" *ngIf="userResults.length === 0">Nessun risultato</div>
        </div>
      </div>

      <!-- Pulsante + per nuovo paziente -->
      <button type="button" class="btn-inline" (click)="openNewPatientModal()" title="Crea nuovo paziente">Ôºã</button>
    </div>

    <div class="actions">
      <button class="btn primary" [disabled]="saving" (click)="saveAppointment()">
        {{ editingRef ? 'Salva' : 'Crea appuntamento' }}
      </button>
      <button class="btn" (click)="modalVisible=false">Annulla</button>
    </div>
  </div>
</div>

<!-- === MODALE DETTAGLI EVENTO === -->
<div class="modal-overlay" *ngIf="detailsVisible" (click)="closeDetails()">
  <div class="modal details" (click)="$event.stopPropagation()">
    <h2>{{ selectedEvent?.title }}</h2>

    <div class="when">
      {{ selectedEvent?.start | date:'EEE d MMM yyyy, HH:mm' }}
      <ng-container *ngIf="selectedEvent?.end">‚Äì {{ selectedEvent?.end | date:'HH:mm' }}</ng-container>
    </div>

    <p class="desc" *ngIf="selectedEvent?.meta?.description as d">{{ d }}</p>

    <div class="assigned" *ngIf="selectedEvent?.meta?.patientId as pid">
      üë§ <strong>{{ getPatientLabel(pid) }}</strong>
    </div>

    <div class="modal-actions">
      <button (click)="editSelected()">Modifica</button>
      <button class="danger" (click)="deleteSelected()">Elimina</button>
      <button (click)="closeDetails()">Chiudi</button>
    </div>
  </div>
</div>

<!-- === SECONDA MODALE: NUOVO PAZIENTE === -->
<div class="modal-overlay modal-overlay--nested" *ngIf="newPatientModalVisible" (click)="cancelNewPatient()">
  <div class="modal modal--nested" (click)="$event.stopPropagation()">
    <h3>Nuovo paziente</h3>

    <div class="inline-new-user">
      <div class="grid">
        <label>
          <span>Nome</span>
          <input [(ngModel)]="newPatient.firstname" placeholder="Mario" />
        </label>
        <label>
          <span>Cognome</span>
          <input [(ngModel)]="newPatient.lastname" placeholder="Rossi" />
        </label>
      </div>

      <div class="grid">
        <label>
          <span>Email</span>
          <input type="email" [(ngModel)]="newPatient.email" placeholder="mario.rossi@example.com" />
        </label>
        <label>
          <span>Data di nascita</span>
          <input type="date" [(ngModel)]="newPatient.dateOfBirth" />
        </label>
      </div>

      <div class="grid">
        <label>
          <span>Indirizzo</span>
          <input [(ngModel)]="newPatient.address" placeholder="Via Roma 123, Milano" />
        </label>
        <label>
          <span>SSN</span>
          <!-- ‚ö†Ô∏è maiuscolo: combacia con il TS (CreatePatientDto.SSN) -->
          <input [(ngModel)]="newPatient.SSN" placeholder="RSSMRA80A01F205X" />
        </label>
      </div>
    </div>

    <div class="modal-actions">
      <button (click)="saveNewPatient()">Crea paziente</button>
      <button (click)="cancelNewPatient()">Annulla</button>
    </div>
  </div>
</div>