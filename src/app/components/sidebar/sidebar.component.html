<!-- TOGGLE SOLO SU MOBILE -->
<div *ngIf="isMobile" class="mobile-toggle">
  <button mat-button (click)="toggleMenu()">☰ Menu</button>
</div>

<!-- SIDEBAR DESKTOP -->
<aside *ngIf="!isMobile" class="sidebar" [class.collapsed]="isCollapsed">
  <button class="collapse-toggle" (click)="toggleCollapse()" [attr.aria-expanded]="!isCollapsed"
    [attr.title]="isCollapsed ? 'Apri sidebar' : 'Comprimi sidebar'">
    <span class="hamburger-icon" aria-hidden="true">
      <span></span><span></span><span></span>
    </span>
  </button>

  <nav>
    <a routerLink="/home" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">
      <span class="icon">🏠</span>
      <span class="text" *ngIf="!isCollapsed">Home</span>
    </a>

    <!-- Gruppo: Pazienti (DESKTOP) -->
    <div class="menu-group" [class.open]="patientsOpen">
      <button class="menu-parent" (click)="togglePatients()" [attr.aria-expanded]="patientsOpen"
        aria-controls="patients-submenu">
        <span class="icon">👥</span>
        <span class="text" *ngIf="!isCollapsed">Pazienti</span>
        <span class="chevron" *ngIf="!isCollapsed" [class.rot]="patientsOpen">▾</span>
      </button>

      <!-- Submenu visibile solo quando la sidebar non è collassata -->
      <div id="patients-submenu" class="submenu" *ngIf="patientsOpen && !isCollapsed">
        <a [routerLink]="['/patients']" [queryParams]="{ status: 'active' }" queryParamsHandling="merge"
          [class.active]="(status$ | async) === 'active'" (click)="closeSubmenus()">Attivi</a>

        <a [routerLink]="['/patients']" [queryParams]="{ status: 'inactive' }" queryParamsHandling="merge"
          [class.active]="(status$ | async) === 'inactive'" (click)="closeSubmenus()">Disattivi</a>
      </div>
    </div>

    <!-- Gruppo: Appuntamenti (DESKTOP) -->
    <div class="menu-group" [class.open]="appointmentsOpen">
      <button class="menu-parent" (click)="toggleAppointments()" [attr.aria-expanded]="appointmentsOpen"
        aria-controls="appointments-submenu">
        <span class="icon">📆</span>
        <span class="text" *ngIf="!isCollapsed">Appuntamenti</span>
        <span class="chevron" *ngIf="!isCollapsed" [class.rot]="appointmentsOpen">▾</span>
      </button>

      <!-- Submenu visibile solo quando la sidebar non è collassata -->
      <div id="appointments-submenu" class="submenu" *ngIf="appointmentsOpen && !isCollapsed">
        <a routerLink="/calendar" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
          (click)="closeSubmenus()">Calendario</a>

        <a routerLink="/appointments" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
          (click)="closeSubmenus()">Lista appuntamenti</a>
      </div>
    </div>

    <a routerLink="/archive" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">
      <span class="icon">🗃️​</span>
      <span class="text" *ngIf="!isCollapsed">​Archivio</span>
    </a>

    <a routerLink="/users" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">
      <span class="icon">🏥​</span>
      <span class="text" *ngIf="!isCollapsed">Studio</span>
    </a>

    <!-- Gruppo: Settings (DESKTOP) -->
    <div class="menu-group" [class.open]="settingsOpen">
      <button class="menu-parent" (click)="toggleSettings()" [attr.aria-expanded]="settingsOpen"
        aria-controls="settings-submenu">
        <span class="icon">⚙️</span>
        <span class="text" *ngIf="!isCollapsed">Settings</span>
        <span class="chevron" *ngIf="!isCollapsed" [class.rot]="settingsOpen">▾</span>
      </button>

      <div id="settings-submenu" class="submenu" *ngIf="settingsOpen && !isCollapsed">
        <a routerLink="/settings/profile" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
          (click)="closeSubmenus()">Profilo</a>

        <a routerLink="/settings/studio" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
          (click)="closeSubmenus()">Studio</a>
      </div>
    </div>
  </nav>

  <!-- Bottoni in basso (DESKTOP) -->
  <div class="sidebar-bottom">
    <button class="logout-btn tip" (click)="logout()" title="Logout" aria-label="Logout">
      <span class="icon" aria-hidden="true">🚪</span>
      <span class="text" *ngIf="!isCollapsed">Logout</span>
    </button>
  </div>
</aside>

<!-- SIDEBAR MOBILE -->
<aside *ngIf="isMobile && menuOpen" class="sidebar mobile open">
  <nav>
    <a routerLink="/home" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
      (click)="menuOpen = false">🏠 Home</a>

    <!-- Gruppo: Pazienti (MOBILE) -->
    <div class="menu-group" [class.open]="patientsOpenMobile">
      <button class="menu-parent" (click)="patientsOpenMobile = !patientsOpenMobile"
        [attr.aria-expanded]="patientsOpenMobile" aria-controls="patients-submenu-m">
        👥 Pazienti
        <span class="chevron" [class.rot]="patientsOpenMobile">▾</span>
      </button>

      <div id="patients-submenu-m" class="submenu" *ngIf="patientsOpenMobile">
        <a [routerLink]="['/patients']" [queryParams]="{ status: 'active' }" queryParamsHandling="merge"
          [class.active]="(status$ | async) === 'active'" (click)="closeMobileMenu()">Attivi</a>

        <a [routerLink]="['/patients']" [queryParams]="{ status: 'inactive' }" queryParamsHandling="merge"
          [class.active]="(status$ | async) === 'inactive'" (click)="closeMobileMenu()">Disattivi</a>
      </div>
    </div>

    <!-- Gruppo: Appuntamenti (MOBILE) -->
    <div class="menu-group" [class.open]="appointmentsOpenMobile">
      <button class="menu-parent" (click)="appointmentsOpenMobile = !appointmentsOpenMobile"
        [attr.aria-expanded]="appointmentsOpenMobile" aria-controls="appointments-submenu-m">
        📆 Appuntamenti
        <span class="chevron" [class.rot]="appointmentsOpenMobile">▾</span>
      </button>

      <div id="appointments-submenu-m" class="submenu" *ngIf="appointmentsOpenMobile">
        <a routerLink="/calendar" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
          (click)="closeMobileMenu()">Calendario</a>

        <a routerLink="/appointments" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
          (click)="closeMobileMenu()">Lista appuntamenti</a>
      </div>
    </div>

    <a routerLink="/archive" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
      (click)="menuOpen = false">🗃️​ Archivio</a>

    <a routerLink="/users" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
      (click)="menuOpen = false">🏥​ Studio</a>

    <!-- Gruppo: Settings (MOBILE) -->
    <div class="menu-group" [class.open]="settingsOpenMobile">
      <button class="menu-parent" (click)="settingsOpenMobile = !settingsOpenMobile"
        [attr.aria-expanded]="settingsOpenMobile" aria-controls="settings-submenu-m">
        ⚙️ Settings
        <span class="chevron" [class.rot]="settingsOpenMobile">▾</span>
      </button>

      <div id="settings-submenu-m" class="submenu" *ngIf="settingsOpenMobile">
        <a routerLink="/settings/profile" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
          (click)="closeMobileMenu()">Profilo</a>

        <a routerLink="/settings/studio" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
          (click)="closeMobileMenu()">Studio</a>
      </div>
    </div>
  </nav>

  <!-- Bottoni in basso (MOBILE) -->
  <div class="sidebar-bottom">
    <button class="logout-btn tip" (click)="logout()" title="Logout" aria-label="Logout">
      <span class="icon" aria-hidden="true">🚪</span>
      <span class="text" *ngIf="!isCollapsed">Logout</span>
    </button>
  </div>
</aside>