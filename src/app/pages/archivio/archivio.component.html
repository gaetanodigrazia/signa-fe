<div class="users-page">
    <div class="toolbar surface">
        <div class="left">
            <h2>Archivio appuntamenti</h2>
        </div>
        <div class="right">
            <input class="search" type="search" placeholder="Cerca paziente‚Ä¶" [(ngModel)]="search"
                (ngModelChange)="applyFilter()" />
            <button class="btn" type="button" (click)="load()" [disabled]="loading">Ricarica</button>
        </div>
    </div>

    <div class="table-wrap surface">
        <table class="users-table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>CF</th>
                    <th>Data di nascita</th>
                    <th>Indirizzo</th>
                    <th class="actions">Azioni</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let p of filtered; trackBy: trackByUuid">
                    <td>
                        <button class="linklike" type="button" (click)="view(p)">
                            {{ p.firstname }} {{ p.lastname }}
                        </button>
                    </td>
                    <td>{{ p.email }}</td>
                    <td>{{ p.SSN }}</td>
                    <td>{{ p.dateOfBirth | date:'d MMM y' }}</td>
                    <td>{{ p.address }}</td>
                    <td class="actions">
                        <button class="icon" type="button" title="Visualizza storico" (click)="view(p)">üëÅÔ∏è</button>
                    </td>
                </tr>
                <tr *ngIf="filtered.length === 0 && !loading">
                    <td colspan="6" class="empty">Nessun paziente trovato.</td>
                </tr>
            </tbody>
        </table>

        <div *ngIf="error" class="error" style="padding:12px;">{{ error }}</div>
    </div>
</div>

<!-- MODALE DETTAGLI + HISTORY -->
<div class="modal-overlay" *ngIf="detailsVisible" (click)="closeDetails()">
    <div class="modal" (click)="$event.stopPropagation()" (keydown.escape)="closeHistoryDetail()">
        <h3>Storico paziente</h3>

        <div class="details" *ngIf="viewing as v">
            <div><strong>Nome:</strong> {{ v.firstname }} {{ v.lastname }}</div>
            <div><strong>Email:</strong> {{ v.email }}</div>
            <div><strong>CF:</strong> {{ v.SSN || 'n/d' }}</div>
            <div><strong>Nascita:</strong> {{ v.dateOfBirth | date:'EEE d MMM y' }}</div>
            <div><strong>Indirizzo:</strong> {{ v.address || '‚Äî' }}</div>
        </div>

        <hr />

        <h4>Storico</h4>

        <!-- stati: loading / errore / vuoto -->
        <div *ngIf="historyLoading" style="padding:8px;">Caricamento storico‚Ä¶</div>
        <div *ngIf="historyError" class="error" style="padding:8px;">{{ historyError }}</div>
        <div *ngIf="!historyLoading && !historyError && (!history || history.length === 0)">
            Nessun appuntamento.
        </div>

        <!-- tabella scrollabile -->
        <div *ngIf="!historyLoading && !historyError && history?.length" class="history-table-wrap" role="region"
            aria-label="Storico appuntamenti">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descrizione</th>
                        <th>Studio</th>
                        <th>Medico</th>
                        <th>Stato</th>
                        <th aria-label="azioni"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let h of history; trackBy: trackByDateDesc">
                        <td>{{ h.date | date:'EEE d MMM y, HH:mm' }}</td>
                        <td>{{ h.description }}</td>
                        <td>{{ h.studioName || '‚Äî' }}</td>
                        <td>{{ h.doctorName || '‚Äî' }}</td>
                        <td>
                            <span class="badge" [class.badge--booked]="h.status==='BOOKED'"
                                [class.badge--done]="h.status==='DONE'"
                                [class.badge--cancelled]="h.status==='CANCELLED'">
                                {{ h.status || '‚Äî' }}
                            </span>
                        </td>
                        <td class="actions">
                            <button type="button" (click)="openHistoryDetail(h)" class="btn-link">Dettaglio</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- DETTAGLIO SINGOLO APPUNTAMENTO -->
        <div class="history-detail surface" *ngIf="selectedHistory as d" role="dialog"
            aria-label="Dettaglio appuntamento" [@detailPulse]="detailAnimKey">
            <div class="history-detail__header">
                <h5>Dettaglio appuntamento</h5>
                <button class="icon" type="button" (click)="closeHistoryDetail()"
                    aria-label="Chiudi dettaglio">‚úñ</button>
            </div>

            <div class="history-detail__grid">
                <div><strong>Data:</strong> {{ d.date | date:'EEE d MMM y, HH:mm' }}</div>
                <div>
                    <strong>Stato:</strong>
                    <span class="badge" [class.badge--booked]="d.status==='BOOKED'"
                        [class.badge--done]="d.status==='DONE'" [class.badge--cancelled]="d.status==='CANCELLED'">
                        {{ d.status || '‚Äî' }}
                    </span>
                </div>
                <div><strong>Studio:</strong> {{ d.studioName || '‚Äî' }}</div>
                <div><strong>Medico:</strong> {{ d.doctorName || '‚Äî' }}</div>
                <div class="col-span-2"><strong>Descrizione:</strong> {{ d.description || '‚Äî' }}</div>
                <div class="col-span-2"><strong>Note:</strong> {{ d.notes || '‚Äî' }}</div>
            </div>

        </div>

        <div class="modal-actions">
            <button class="btn" type="button" (click)="closeDetails()">Chiudi</button>
        </div>
    </div>
</div>