<div class="users-page">
    <div class="toolbar surface">
        <div class="left">
            <h2>Pazienti</h2>
        </div>
        <div class="right">
            <input class="search" type="search" placeholder="Cerca paziente‚Ä¶" [(ngModel)]="search"
                (ngModelChange)="applyFilter()" />
            <button class="btn primary" (click)="openNew()">Ôºã Nuovo paziente</button>
        </div>
    </div>

    <div class="table-wrap surface">
        <table class="users-table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Telefono</th>
                    <th>CF</th>
                    <th>Data di nascita</th>
                    <th>Indirizzo</th>
                    <th class="actions">Azioni</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let p of filtered; trackBy: trackByUuid">
                    <td><button class="linklike" (click)="view(p)">{{ p.firstname }} {{ p.lastname }}</button></td>
                    <td>{{ p.email }}</td>
                    <td>{{ p.phone || '‚Äî' }}</td>
                    <td>{{ p.SSN || p.ssn }}</td>
                    <td>{{ p.dateOfBirth | date: 'd MMM y' }}</td>
                    <td>{{ p.address }}</td>
                    <td class="actions">
                        <!-- Azioni per lista "active" -->
                        <ng-container *ngIf="status === 'active'; else actionsInactive">
                            <button class="icon" title="Vedi" (click)="view(p)">üëÅÔ∏è</button>
                            <button class="icon" title="Modifica" (click)="edit(p)">‚úèÔ∏è</button>
                            <button class="icon" title="Disattiva" [disabled]="changingStatus"
                                (click)="deactivate(p)">üõë</button>
                        </ng-container>

                        <!-- Azioni per lista "inactive" -->
                        <ng-template #actionsInactive>
                            <button class="icon" title="Vedi" (click)="view(p)">üëÅÔ∏è</button>
                            <button class="icon" title="Attiva" [disabled]="changingStatus"
                                (click)="activate(p)">‚úÖ</button>
                            <button class="icon danger" title="Elimina" [disabled]="deleting"
                                (click)="askDelete(p)">üóëÔ∏è</button>
                        </ng-template>
                    </td>


                </tr>
                <tr *ngIf="filtered.length === 0 && !loading">
                    <td colspan="6" class="empty">Nessun paziente trovato.</td>
                </tr>
            </tbody>
        </table>

        <div *ngIf="error" class="error" style="padding:12px;">{{ error }}</div>
    </div>
</div>

<!-- MODALE CREA / MODIFICA -->
<div class="modal-overlay" *ngIf="modalVisible" (click)="cancelModal()">
    <div class="modal" (click)="$event.stopPropagation()">
        <h3>{{ editing ? 'Modifica paziente' : 'Nuovo paziente' }}</h3>

        <form #patientForm="ngForm" (ngSubmit)="save()" novalidate>
            <!-- Nome -->
            <label>
                <span>Nome</span>
                <input name="firstname" [(ngModel)]="form.firstname" required #firstname="ngModel" />
                <div class="error" *ngIf="(submitted || firstname.touched) && firstname.invalid">
                    Il nome √® obbligatorio.
                </div>
            </label>

            <!-- Cognome -->
            <label>
                <span>Cognome</span>
                <input name="lastname" [(ngModel)]="form.lastname" required #lastname="ngModel" />
                <div class="error" *ngIf="(submitted || lastname.touched) && lastname.invalid">
                    Il cognome √® obbligatorio.
                </div>
            </label>

            <!-- Email -->
            <label>
                <span>Email</span>
                <input name="email" type="email" [(ngModel)]="form.email" required email #email="ngModel" />
                <div class="error" *ngIf="(submitted || email.touched) && email.errors?.['required']">
                    L'email √® obbligatoria.
                </div>
                <div class="error" *ngIf="(submitted || email.touched) && email.errors?.['email']">
                    Inserisci un'email valida.
                </div>
            </label>


            <!-- Telefono (opzionale con pattern) -->
            <label>
                <span>Telefono</span>
                <input name="phone" [(ngModel)]="form.phone" pattern="^[+0-9 ().-]{6,20}$" #phone="ngModel"
                    autocomplete="tel" />
                <div class="error" *ngIf="(submitted || phone.touched) && phone.errors?.['pattern']">
                    Inserisci un numero valido.
                </div>
            </label>

            <!-- Codice Fiscale (opzionale con pattern) -->
            <label>
                <span>Codice Fiscale</span>
                <input name="ssn" [(ngModel)]="form.ssn" pattern="[A-Za-z0-9]{11,16}" #ssn="ngModel"
                    autocomplete="off" />
                <div class="error" *ngIf="(submitted || ssn.touched) && ssn.errors?.['pattern']">
                    Formato codice fiscale non valido.
                </div>
            </label>

            <!-- Data di nascita (obbligatoria) -->
            <label>
                <span>Data di nascita</span>
                <input name="dob" type="date" [(ngModel)]="form.dateOfBirth" required [attr.max]="today"
                    #dob="ngModel" />
                <div class="error" *ngIf="(submitted || dob.touched) && dob.invalid">
                    La data di nascita √® obbligatoria.
                </div>
            </label>

            <!-- Indirizzo -->
            <label>
                <span>Indirizzo</span>
                <input name="address" [(ngModel)]="form.address" />
            </label>

            <div class="modal-actions">
                <button class="btn primary" type="submit" [disabled]="submitted && patientForm.invalid">
                    {{ editing ? 'Salva modifiche' : 'Crea paziente' }}
                </button>
                <button class="btn" type="button" (click)="cancelModal()">Annulla</button>
            </div>
        </form>
    </div>
</div>



<!-- MODALE DETTAGLI -->
<div class="modal-overlay" *ngIf="detailsVisible" (click)="closeDetails()">
    <div class="modal" (click)="$event.stopPropagation()">
        <h3>Dettagli paziente</h3>
        <div class="details" *ngIf="viewing as v">
            <div><strong>Nome:</strong> {{ v.firstname }} {{ v.lastname }}</div>
            <div><strong>Email:</strong> {{ v.email }}</div>
            <div><strong>Telefono:</strong> {{ v.phone || '‚Äî' }}</div>
            <div><strong>CF:</strong> {{ v.SSN || v.ssn || 'n/d' }}</div>
            <div><strong>Nascita:</strong> {{ v.dateOfBirth | date:'EEE d MMM y' }}</div>
            <div><strong>Indirizzo:</strong> {{ v.address || '‚Äî' }}</div>
        </div>
        <div class="modal-actions">
            <button class="btn" (click)="closeDetails()">Chiudi</button>
        </div>
    </div>
</div>

<!-- MODALE CONFERMA ELIMINA -->
<div class="modal-overlay" *ngIf="confirmVisible" (click)="confirmVisible=false">
    <div class="modal" (click)="$event.stopPropagation()">
        <h3>Elimina paziente</h3>
        <p>Sei sicuro di voler eliminare <strong>{{ toDelete?.firstname }} {{ toDelete?.lastname }}</strong>?</p>
        <div class="modal-actions">
            <button class="btn danger" (click)="confirmDelete()">Elimina</button>
            <button class="btn" (click)="confirmVisible=false; toDelete=null">Annulla</button>
        </div>
    </div>
</div>

<!-- Overlay caricamento globale (centrato e sopra la tabella) -->
<div class="page-loading-overlay" *ngIf="loading" role="status" aria-live="polite" aria-busy="true">
    <span class="spinner spinner--big" aria-hidden="true"></span>
    <span class="sr-only">Caricamento pazienti‚Ä¶</span>
</div>