<div class="users-page">
    <div class="toolbar surface">
        <div class="left">
            <h2>Collaboratori</h2>
        </div>
        <div class="right">
            <input class="search" type="search" placeholder="Cerca utente‚Ä¶" [(ngModel)]="search"
                (ngModelChange)="applyFilter()" />
            <button type="button" class="btn primary" (click)="openNew()">Ôºã Nuovo utente</button>
        </div>
    </div>

    <div class="table-wrap surface">
        <table class="users-table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Stato</th>
                    <th>Creato</th>
                    <th class="actions">Azioni</th>
                </tr>
            </thead>

            <tbody>
                <tr *ngFor="let u of filtered; trackBy: trackById" [attr.data-member-id]="u.id || 'NO-ID'">
                    <td>
                        <button type="button" class="linklike" (click)="view(u)">
                            {{ u.firstName || (u['name'] ? u['name'].split(' ')[0] : '') }}
                            {{ u.lastName || (u['name'] ? u['name'].split(' ').slice(1).join(' ') : '') }}
                        </button>
                    </td>
                    <td>{{ u.email }}</td>
                    <td>
                        <span class="badge" [class.ok]="u.active" [class.off]="!u.active">
                            {{ u.active ? 'Attivo' : 'Sospeso' }}
                        </span>
                    </td>
                    <td>
                        <ng-container *ngIf="u.createdAt; else noDate">
                            {{ u.createdAt | date:'d MMM y' }}
                        </ng-container>
                        <ng-template #noDate>‚Äî</ng-template>
                    </td>

                    <td class="actions">
                        <button type="button" class="icon" title="Vedi" (click)="view(u)">üëÅÔ∏è</button>
                        <button type="button" class="icon" title="Modifica" (click)="edit(u)">‚úèÔ∏è</button>

                        <!-- Se attivo ‚Üí Sospendi -->
                        <button *ngIf="u.active" type="button" class="icon warning" title="Sospendi"
                            (click)="suspend(u)">‚è∏Ô∏è</button>

                        <!-- Se sospeso ‚Üí Elimina -->
                        <button *ngIf="!u.active" type="button" class="icon danger" title="Elimina"
                            (click)="askDelete(u)">üóëÔ∏è</button>
                    </td>
                </tr>

                <tr *ngIf="filtered.length === 0">
                    <td colspan="5" class="empty">Nessun utente trovato.</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- MODALE CREA/MODIFICA (wizard) -->
<div class="modal-overlay" *ngIf="modalVisible" (click)="cancelModal()">
    <div class="modal" (click)="$event.stopPropagation()">
        <h3>{{ editing ? 'Modifica utente' : 'Nuovo utente' }}</h3>

        <!-- Stepper -->
        <ol class="stepper">
            <li [class.done]="step>0" [class.active]="step===0">Utente</li>
            <li [class.done]="step>1" [class.active]="step===1">Appartenenze</li>
            <li [class.active]="step===2">Riepilogo</li>
        </ol>

        <form (ngSubmit)="save()" #userForm="ngForm" novalidate>
            <!-- STEP 0: Dati utente -->
            <div *ngIf="step===0" class="tab-content">
                <label>
                    <span>Nome</span>
                    <input [(ngModel)]="form.firstName" name="firstName" required />
                </label>

                <label>
                    <span>Cognome</span>
                    <input [(ngModel)]="form.lastName" name="lastName" required />
                </label>

                <label>
                    <span>Email</span>
                    <input type="email" [(ngModel)]="form.email" name="email" required />
                </label>

                <label>
                    <span>Telefono</span>
                    <input type="tel" [(ngModel)]="form.phone" name="phone" />
                </label>

                <label class="row">
                    <input type="checkbox" [(ngModel)]="form.active" name="active" />
                    <span>Attivo</span>
                </label>
            </div>

            <!-- STEP 1: Appartenenze -->
            <div *ngIf="step===1" class="tab-content">
                <h4>Appartenenze agli studi</h4>
                <div class="hint">Aggiungi gli studi e il ruolo dell‚Äôutente.</div>

                <div class="studio-memberships">
                    <div class="membership-row"
                        *ngFor="let m of form.memberships; let i = index; trackBy: trackByMembership">
                        <label>
                            <span>Studio</span>
                            <select [(ngModel)]="m.studioId" name="studio-{{i}}">
                                <option [ngValue]="null" disabled>Seleziona‚Ä¶</option>
                                <option *ngFor="let s of studios" [ngValue]="s.id">{{ s.name }}</option>
                            </select>
                        </label>

                        <label>
                            <span>Ruolo nello studio</span>
                            <select [(ngModel)]="m.role" name="studio-role-{{i}}">
                                <option *ngFor="let r of studioRoles" [ngValue]="r">{{ r }}</option>
                            </select>
                        </label>

                        <label class="row">
                            <input type="checkbox" [(ngModel)]="m.active" name="studio-active-{{i}}" />
                            <span>Attivo</span>
                        </label>

                        <button type="button" class="icon danger" (click)="removeMembership(i)">üóëÔ∏è</button>
                    </div>

                    <button type="button" class="btn" (click)="addMembership()">Ôºã Aggiungi studio</button>
                </div>
            </div>

            <!-- STEP 2: Riepilogo -->
            <div *ngIf="step===2" class="tab-content">
                <h4>Riepilogo</h4>
                <div class="summary">
                    <div><strong>Nome:</strong> {{ form.firstName }} {{ form.lastName }}</div>
                    <div><strong>Email:</strong> {{ form.email }}</div>
                    <div><strong>Telefono:</strong> {{ form.phone || '‚Äî' }}</div>
                    <div>
                        <strong>Stato:</strong>
                        <span class="badge" [class.ok]="form.active" [class.off]="!form.active">
                            {{ form.active ? 'Attivo' : 'Sospeso' }}
                        </span>
                    </div>

                    <div class="mt">
                        <strong>Appartenenze:</strong>
                        <ul>
                            <li *ngFor="let m of form.memberships | slice:0">
                                <ng-container *ngIf="m.studioId; else empty">
                                    {{ studioName(m.studioId) }} ‚Äî {{ m.role }}
                                    <span class="badge small" [class.ok]="m.active" [class.off]="!m.active">
                                        {{ m.active ? 'Attiva' : 'Sospesa' }}
                                    </span>
                                </ng-container>
                                <ng-template #empty>riga vuota (non verr√† salvata)</ng-template>
                            </li>
                            <li *ngIf="!form.memberships.length">Nessuna</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Footer azioni wizard -->
            <div class="modal-actions between">
                <div class="left">
                    <button type="button" class="btn" (click)="cancelModal()">Annulla</button>
                </div>
                <div class="right">
                    <button *ngIf="step>0" type="button" class="btn" (click)="prev()">Indietro</button>
                    <button *ngIf="step<2" type="button" class="btn primary" [disabled]="!isStepValid(step)"
                        (click)="next()">Avanti</button>
                    <button *ngIf="step===2" class="btn primary" type="submit">Conferma</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- MODALE DETTAGLI -->
<div class="modal-overlay" *ngIf="detailsVisible" (click)="closeDetails()">
    <div class="modal" (click)="$event.stopPropagation()">
        <h3>Dettagli utente</h3>

        <div class="details" *ngIf="viewing as v">
            <div><strong>Nome:</strong> {{ v.user?.firstName }} {{ v.user?.lastName }}</div>
            <div><strong>Email:</strong> {{ v.user?.email }}</div>
            <div><strong>Ruolo:</strong> {{ v.role }}</div>

            <div>
                <strong>Stato:</strong>
                <span class="badge" [class.ok]="v.active" [class.off]="!v.active">
                    {{ v.active ? 'Attivo' : 'Sospeso' }}
                </span>
            </div>

            <div *ngIf="v.user?.createdAt as created">
                <strong>Creato:</strong> {{ created | date:'EEE d MMM y, HH:mm' }}
            </div>

            <div *ngIf="v.user?.updatedAt as updated">
                <strong>Aggiornato:</strong> {{ updated | date:'EEE d MMM y, HH:mm' }}
            </div>
        </div>

        <!-- IMPORTANTE: qui estendiamo lo scope di v -->
        <div class="modal-actions" *ngIf="viewing as v">
            <button type="button" class="btn" (click)="editFromDetails(v)">Modifica</button>

            <!-- Se attivo ‚Üí pulsante Sospendi -->
            <button *ngIf="v.active" type="button" class="btn warning" (click)="suspendFromDetails(v)">Sospendi</button>

            <!-- Se sospeso ‚Üí pulsante Elimina -->
            <button *ngIf="!v.active" type="button" class="btn danger"
                (click)="askDeleteFromDetails(v)">Elimina</button>

            <button type="button" class="btn" (click)="closeDetails()">Chiudi</button>
        </div>

    </div>
</div>

<!-- MODALE CONFERMA DELETE -->
<div class="modal-overlay" *ngIf="confirmVisible" (click)="confirmVisible = false">
    <div class="modal small" (click)="$event.stopPropagation()">
        <h3>Eliminare questo utente?</h3>
        <p *ngIf="toDelete as d">
            Questa azione non √® reversibile.
            <strong>{{ d.firstName }} {{ d.lastName }}</strong>
        </p>
        <div class="modal-actions">
            <button type="button" class="btn danger" (click)="confirmDelete()">Elimina</button>
            <button type="button" class="btn" (click)="confirmVisible = false">Annulla</button>
        </div>
    </div>
</div>

<!-- Overlay caricamento globale -->
<div class="page-loading-overlay" *ngIf="loading" role="status" aria-live="polite">
    <span class="spinner spinner--big" aria-hidden="true"></span>
    <span class="sr-only">Caricamento pazienti‚Ä¶</span>
</div>