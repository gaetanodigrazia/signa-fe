<div class="users-page">
    <div class="toolbar surface">
        <div class="left">
            <h2>Appuntamenti</h2>
        </div>
        <div class="right">
            <input type="date" [(ngModel)]="startDate" (ngModelChange)="load()" title="Data inizio" />
            <input type="date" [(ngModel)]="endDate" (ngModelChange)="load()" title="Data fine" />

            <select [(ngModel)]="status" (ngModelChange)="load()" title="Filtra per stato">
                <option value="BOOKED">Prenotati</option>
                <option value="CONFIRMED">Confermati</option>
                <option value="CLOSED">Conclusi</option>
                <option value="CANCELLED">Cancellati</option>
            </select>

            <!-- üîç Campo ricerca paziente -->
            <input type="text" [(ngModel)]="patientSearch" (ngModelChange)="load()" placeholder="Cerca paziente..."
                title="Cerca paziente" />
        </div>

    </div>

    <ng-container *ngIf="groupedAppointments | keyvalue as dates">
        <div *ngIf="dates.length === 0 && !loading" class="table-wrap surface">
            <div class="empty">Nessun appuntamento trovato per questo periodo.</div>
        </div>

        <div *ngFor="let date of dates" class="table-wrap surface appointments-group">
            <h3 class="group-date">{{ date.key | date:'EEEE d MMMM y' }}</h3>
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Paziente</th>
                        <th>Ora</th>
                        <th>Stato</th>
                        <th class="actions">Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let appt of date.value; trackBy: trackByUuid">
                        <td><button class="linklike" (click)="view(appt)">{{ appt.patient?.firstname }} {{
                                appt.patient?.lastname }}</button></td>
                        <td>{{ appt.startAt | date:'HH:mm' }} - {{ appt.endAt | date:'HH:mm' }}</td>
                        <td>
                            <span class="badge" [ngClass]="appt.status">
                                {{ appt.status | lowercase }}
                            </span>

                        </td>

                        <td class="actions">
                            <button class="icon" title="Vedi dettagli" (click)="view(appt)">üëÅÔ∏è</button>
                            <button class="icon" title="Modifica" (click)="openEdit(appt)">‚úèÔ∏è</button>
                            <button class="icon" title="Nuovo appuntamento"
                                (click)="createAppointmentForUser(appt.patient?.id)">‚ûï</button>
                            <button class="icon"
                                *ngIf="appt?.id && (appt.status === 'BOOKED' || appt.status === 'CONFIRMED')"
                                [routerLink]="['/evento-iniziato', appt.id]" [state]="{ appt: appt }" type="button">
                                ‚ñ∂Ô∏è
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </ng-container>

    <div *ngIf="error" class="error" style="padding:12px;">{{ error }}</div>
</div>

<div class="modal-overlay" *ngIf="detailsVisible" (click)="closeDetails()" role="dialog" aria-modal="true"
    aria-labelledby="appt-dialog-title">

    <div class="modal" (click)="$event.stopPropagation()" (keydown.escape)="closeDetails()" tabindex="-1">

        <h3 id="appt-dialog-title">Dettagli appuntamento</h3>

        <div class="details" *ngIf="viewing as v">
            <div><strong>Paziente:</strong> {{ fmtPatientName(v) }}</div>
            <div><strong>Dottore:</strong> {{ fmtDoctorName(v) }}</div>
            <div><strong>Studio:</strong> {{ fmtStudioName(v) }}</div>

            <div><strong>Tipo:</strong> {{ fmtKind(v.kind) }}</div>
            <div><strong>Stato:</strong> {{ fmtStatus(v.status) }}</div>
            <div><strong>Motivo:</strong> {{ v.reason || '‚Äî' }}</div>
            <div><strong>Note:</strong> {{ v.notes || '‚Äî' }}</div>

            <div><strong>Data:</strong> {{ v.startAt | date:'d MMMM y' }}</div>
            <div><strong>Ora:</strong> {{ v.startAt | date:'shortTime' }} - {{ v.endAt | date:'shortTime' }}</div>

            <div><strong>Creato da:</strong> {{ fmtCreatedBy(v) }}</div>
            <div><strong>Creato il:</strong> {{ v.createdAt ? (v.createdAt | date:'d MMM y, HH:mm') : '‚Äî' }}</div>

            <div><strong>Cancellato il:</strong> {{ v.canceledAt ? (v.canceledAt | date:'d MMM y, HH:mm') : '‚Äî' }}</div>
            <div><strong>Motivo cancellazione:</strong> {{ v.cancelReason || '‚Äî' }}</div>

            <div><strong>Esito:</strong>
                <button class="btn small" (click)="openResult()">Apri esito</button>
            </div>
        </div>


        <div class="modal-actions">
            <button class="btn" #closeBtn (click)="closeDetails()">Chiudi</button>
        </div>
    </div>
</div>
<div class="modal-overlay" *ngIf="resultVisible" (click)="closeResult()" role="dialog" aria-modal="true"
    aria-labelledby="result-dialog-title">

    <div class="modal large" (click)="$event.stopPropagation()" (keydown.escape)="closeResult()" tabindex="-1">

        <h3 id="result-dialog-title">Esito appuntamento</h3>

        <div class="result-text">
            {{ viewing?.result || 'Nessun esito inserito.' }}
        </div>

        <div class="modal-actions">
            <button class="btn" (click)="closeResult()">Chiudi</button>
        </div>
    </div>
</div>


<!-- Modale: Modifica appuntamento (lista) -->
<div class="modal-overlay" *ngIf="editVisible" (click)="closeEdit()" role="dialog" aria-modal="true"
    aria-labelledby="edit-dialog-title">

    <div class="modal" (click)="$event.stopPropagation()" (keydown.escape)="closeEdit()" tabindex="-1">
        <h3 id="edit-dialog-title">Modifica appuntamento</h3>

        <form class="form-grid" (submit)="$event.preventDefault(); saveEdit()">
            <label>Data</label>
            <input type="date" [(ngModel)]="editModel.date" name="date" required>

            <label>Inizio</label>
            <input type="time" [(ngModel)]="editModel.startTime" name="startTime" required>

            <label>Fine</label>
            <input type="time" [(ngModel)]="editModel.endTime" name="endTime" required>

            <label>Stato</label>
            <select [(ngModel)]="editModel.status" name="status">
                <option value="BOOKED">Prenotato</option>
                <option value="CONFIRMED">Confermato</option>
                <option value="CLOSED">Concluso</option>
                <option value="CANCELLED">Cancellato</option>
            </select>

            <label>Motivo</label>
            <input type="text" [(ngModel)]="editModel.reason" name="reason" placeholder="Motivo (titolo)">

            <label>Note</label>
            <textarea rows="4" [(ngModel)]="editModel.notes" name="notes" placeholder="Note (opzionale)"></textarea>
        </form>

        <div class="modal-actions">
            <button class="btn" type="button" (click)="closeEdit()">Annulla</button>
            <button class="btn-outline btn-danger" type="button" (click)="deleteEditing()">Elimina</button>
            <button class="btn-primary" type="button" (click)="saveEdit()">Salva</button>
        </div>
    </div>
</div>