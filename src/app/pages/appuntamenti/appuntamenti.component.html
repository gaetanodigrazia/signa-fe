<div class="users-page">
    <div class="toolbar surface">
        <div class="left">
            <h2>Appuntamenti</h2>
        </div>
        <div class="right">
            <input type="date" [(ngModel)]="startDate" (ngModelChange)="load()" title="Data inizio" />
            <input type="date" [(ngModel)]="endDate" (ngModelChange)="load()" title="Data fine" />

            <select [(ngModel)]="status" (ngModelChange)="load()" title="Filtra per stato">
                <option value="BOOKED">Prenotati</option>
                <option value="CONFIRMED">Confermati</option>
                <option value="CLOSED">Concluso</option>
                <option value="CANCELLED">Cancellato</option>
            </select>

            <!-- 🔍 Campo ricerca paziente -->
            <input type="text" [(ngModel)]="patientSearch" (ngModelChange)="load()" placeholder="Cerca paziente..."
                title="Cerca paziente" />
        </div>

    </div>

    <ng-container *ngIf="groupedAppointments | keyvalue as dates">
        <div *ngIf="dates.length === 0 && !loading" class="table-wrap surface">
            <div class="empty">Nessun appuntamento trovato per questo periodo.</div>
        </div>

        <div *ngFor="let date of dates" class="table-wrap surface appointments-group">
            <h3 class="group-date">{{ date.key | date:'EEEE d MMMM y' }}</h3>
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Paziente</th>
                        <th>Ora</th>
                        <th>Stato</th>
                        <th class="actions">Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let appt of date.value; trackBy: trackByUuid">
                        <td><button class="linklike" (click)="view(appt)">{{ appt.patient?.firstname }} {{
                                appt.patient?.lastname }}</button></td>
                        <td>{{ appt.startAt | date:'HH:mm' }} - {{ appt.endAt | date:'HH:mm' }}</td>
                        <td>
                            <span class="badge" [ngClass]="appt.status">
                                {{ appt.status | lowercase }}
                            </span>

                        </td>
                        <td class="actions">
                            <button class="icon" title="Vedi dettagli" (click)="view(appt)">➕</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </ng-container>

    <div *ngIf="error" class="error" style="padding:12px;">{{ error }}</div>
</div>

<div class="modal-overlay" *ngIf="detailsVisible" (click)="closeDetails()">
    <div class="modal" (click)="$event.stopPropagation()">
        <h3>Dettagli appuntamento</h3>
        <div class="details" *ngIf="viewing as v">
            <div><strong>Paziente:</strong> {{ v.patient?.firstname }} {{ v.patient?.lastname }}</div>
            <div><strong>Data:</strong> {{ v.startAt | date:'d MMMM y' }}</div>
            <div><strong>Ora:</strong> {{ v.startAt | date:'shortTime' }} - {{ v.endAt | date:'shortTime' }}</div>
            <div><strong>Stato:</strong> {{ v.status }}</div>
            <div *ngIf="v.kind"><strong>Tipo:</strong> {{ v.kind }}</div>
            <div *ngIf="v.reason"><strong>Motivo:</strong> {{ v.reason }}</div>
            <div *ngIf="v.notes"><strong>Note:</strong> {{ v.notes }}</div>
            <div *ngIf="v.doctor"><strong>Dottore:</strong> {{ v.doctor.firstname }} {{ v.doctor.lastname }}</div>
            <div *ngIf="v.studio"><strong>Studio:</strong> {{ v.studio.name }}</div>
        </div>
        <div class="modal-actions">
            <button class="btn" (click)="closeDetails()">Chiudi</button>
        </div>
    </div>
</div>

<div class="page-loading-overlay" *ngIf="loading" role="status" aria-live="polite" aria-busy="true">
    <span class="spinner spinner--big" aria-hidden="true"></span>
    <span class="sr-only">Caricamento appuntamenti…</span>
</div>