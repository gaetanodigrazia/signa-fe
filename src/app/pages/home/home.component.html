<div class="home">

    <div class="toolbar surface">
        <div class="left">
            <h2>Cruscotto operativo</h2>
            <p class="subtitle">Situazione di oggi</p>
        </div>
        <div class="right">
            <button class="btn" type="button" (click)="refresh()" [disabled]="loadingAll">Aggiorna</button>
        </div>
    </div>

    <!-- KPI -->
    <section class="grid kpi">
        <article class="card surface">
            <header class="card-kpi-header">Appuntamenti oggi</header>
            <div class="kpi-value">{{ stats.todayTotal }}</div>
            <footer class="kpi-extra">
                <span class="badge">Confermati: {{ stats.todayConfirmed }}</span>
                <span class="badge">Cancellati: {{ stats.todayCancelled }}</span>
            </footer>
        </article>

        <article class="card surface">
            <header class="card-kpi-header">Pazienti attivi</header>
            <div class="kpi-value">{{ stats.activePatients }}</div>
            <footer class="kpi-extra">Inattivi: {{ stats.inactivePatients }}</footer>
        </article>

        <article class="card surface">
            <header class="card-kpi-header">Tasso cancellazioni (30gg)</header>
            <div class="kpi-value">{{ stats.cancellationRate30d | percent:'1.0-1' }}</div>
            <footer class="kpi-extra">su tutti gli appuntamenti</footer>
        </article>
    </section>

    <!-- DUE COLONNE -->
    <section class="grid two">
        <!-- Appuntamenti -->
        <article class="card surface">
            <header class="card-header">
                <h3>Prossimi appuntamenti (oggi)</h3>
                <button class="btn-link" type="button" routerLink="/calendar">Calendario completo â†’</button>
            </header>

            <div *ngIf="loadingUpcoming" class="skeleton">Caricamento appuntamentiâ€¦</div>
            <div *ngIf="!loadingUpcoming && upcoming.length === 0" class="empty">Nessun appuntamento imminente.</div>

            <ul class="list" *ngIf="!loadingUpcoming && upcoming.length">
                <li *ngFor="let a of upcoming; trackBy: trackByAppt">
                    <div class="time">{{ a.startAt | date:'HH:mm' }}<ng-container *ngIf="a.endAt">â€“{{ a.endAt |
                            date:'HH:mm' }}</ng-container></div>
                    <div class="main">
                        <div class="title">{{ a.reason || a.kind || 'Appuntamento' }}</div>
                        <div class="meta">
                            <span>ðŸ‘¤ {{ (a.patient?.firstname || '') + ' ' + (a.patient?.lastname || '') }}</span>
                            <span *ngIf="a.doctor?.user?.firstName || a.doctor?.user?.lastName"> Â· {{
                                (a.doctor?.user?.firstName || '') + ' ' + (a.doctor?.user?.lastName || '') }}</span>
                        </div>
                    </div>
                    <div class="status">
                        <span class="badge" [class.badge--booked]="a.status==='BOOKED'"
                            [class.badge--confirmed]="a.status==='CONFIRMED'"
                            [class.badge--closed]="a.status==='CLOSED'"
                            [class.badge--cancelled]="a.status==='CANCELLED'">
                            {{ a.status || 'â€”' }}
                        </span>
                    </div>
                    <div class="actions">
                        <button class="btn-outline" type="button" routerLink="/calendar">Apri</button>
                    </div>
                </li>
            </ul>
        </article>

        <!-- Pazienti -->
        <article class="card surface">
            <header class="card-header">
                <h3>Pazienti</h3>
                <button class="btn-link" type="button" routerLink="/patients">Gestisci pazienti â†’</button>
            </header>

            <div *ngIf="loadingPatients" class="skeleton">Caricamento pazientiâ€¦</div>
            <div *ngIf="!loadingPatients && recentPatients.length === 0" class="empty">Nessun paziente da mostrare.
            </div>

            <ul class="list" *ngIf="!loadingPatients && recentPatients.length">
                <li *ngFor="let p of recentPatients; trackBy: trackByPatient">
                    <div class="avatar">{{ (p.firstname || '?')[0] }}{{ (p.lastname || '')[0] }}</div>
                    <div class="main">
                        <div class="title">{{ p.firstname }} {{ p.lastname }}</div>
                        <div class="meta">
                            <span>{{ p.email || 'â€”' }}</span>
                            <span *ngIf="p.dateOfBirth"> Â· {{ p.dateOfBirth | date:'d MMM y' }}</span>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn-outline" type="button" (click)="openPatient(p)">Apri</button>
                    </div>
                </li>
            </ul>
        </article>
    </section>

    <!-- Overlay -->
    <div class="page-loading-overlay" *ngIf="loadingAll" role="status" aria-live="polite" aria-busy="true">
        <span class="spinner spinner--big" aria-hidden="true"></span>
        <span class="sr-only">Caricamento dashboardâ€¦</span>
    </div>
</div>