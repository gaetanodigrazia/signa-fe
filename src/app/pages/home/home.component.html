<div class="home">

    <div class="toolbar surface">
        <div class="left">
            <h2>Cruscotto operativo</h2>
            <p class="subtitle">Situazione di oggi</p>
        </div>
        <div class="right">
            <button class="btn-refresh" type="button" (click)="createAppointment()">
                ‚ûï Nuovo appuntamento
            </button>
        </div>
    </div>

    <!-- KPI -->
    <section class="cards-grid kpi">
        <article class="card surface">
            <header class="card__title">Appuntamenti oggi</header>
            <div class="card__value kpi-value">{{ stats.todayTotal }}</div>
            <footer class="card__meta kpi-extra">
                <span class="badge">Confermati: {{ stats.todayConfirmed }}</span>
                <span class="badge">Cancellati: {{ stats.todayCancelled }}</span>
            </footer>
        </article>

        <article class="card surface">
            <header class="card__title">Pazienti attivi</header>
            <div class="card__value kpi-value">{{ stats.activePatients }}</div>
            <footer class="card__meta kpi-extra">
                Inattivi: {{ stats.inactivePatients }}
            </footer>
        </article>

        <article class="card surface">
            <header class="card__title">Tasso cancellazioni (30gg)</header>
            <div class="card__value kpi-value">
                {{ stats.cancellationRate30d | percent:'1.0-1' }}
            </div>
            <footer class="card__meta kpi-extra">su tutti gli appuntamenti</footer>
        </article>
    </section>

    <!-- DUE COLONNE -->
    <section class="cards-grid two">
        <!-- Appuntamenti -->
        <article class="card surface">
            <header class="card-header">
                <h3 class="card__title">Prossimi appuntamenti (oggi)</h3>
                <button class="btn-link" type="button" routerLink="/calendar">
                    Calendario completo ‚Üí
                </button>
            </header>

            <div *ngIf="loadingUpcoming" class="skeleton">Caricamento appuntamenti‚Ä¶</div>
            <div *ngIf="!loadingUpcoming && upcoming.length === 0" class="empty">
                Nessun appuntamento imminente.
            </div>

            <ul class="list" *ngIf="!loadingUpcoming && upcoming.length">
                <li *ngFor="let a of upcoming; trackBy: trackByAppt">
                    <div class="time">
                        {{ a.startAt | date:'HH:mm' }}
                        <ng-container *ngIf="a.endAt">‚Äì{{ a.endAt | date:'HH:mm' }}</ng-container>
                    </div>
                    <div class="main">
                        <div class="title">
                            {{ a.reason || a.kind || 'Appuntamento' }}
                        </div>
                        <div class="meta">
                            <span>üë§ {{ (a.patient?.firstname || '') + ' ' + (a.patient?.lastname || '') }}</span>
                            <span *ngIf="a.doctor?.user?.firstName || a.doctor?.user?.lastName">
                                ¬∑ {{ (a.doctor?.user?.firstName || '') + ' ' + (a.doctor?.user?.lastName || '') }}
                            </span>
                        </div>
                    </div>
                    <div class="status">
                        <span class="badge" [class.badge--booked]="a.status==='BOOKED'"
                            [class.badge--confirmed]="a.status==='CONFIRMED'"
                            [class.badge--closed]="a.status==='CLOSED'"
                            [class.badge--cancelled]="a.status==='CANCELLED'">
                            {{ a.status || '‚Äî' }}
                        </span>
                    </div>
                    <div class="actions">
                        <button class="btn-outline" type="button" (click)="openAppointment(a)">Apri</button>
                    </div>
                </li>
            </ul>
        </article>

        <!-- Pazienti -->
        <article class="card surface">
            <header class="card-header">
                <h3 class="card__title">Pazienti</h3>
                <button class="btn-link" type="button" routerLink="/patients">
                    Gestisci pazienti ‚Üí
                </button>
            </header>

            <div *ngIf="loadingPatients" class="skeleton">Caricamento pazienti‚Ä¶</div>
            <div *ngIf="!loadingPatients && recentPatients.length === 0" class="empty">
                Nessun paziente da mostrare.
            </div>

            <ul class="list" *ngIf="!loadingPatients && recentPatients.length">
                <li *ngFor="let p of recentPatients; trackBy: trackByPatient">
                    <div class="avatar">
                        {{ (p.firstname || '?')[0] }}{{ (p.lastname || '')[0] }}
                    </div>
                    <div class="main">
                        <div class="title">{{ p.firstname }} {{ p.lastname }}</div>
                        <div class="meta">
                            <span>{{ p.email || '‚Äî' }}</span>
                            <span *ngIf="p.dateOfBirth"> ¬∑ {{ p.dateOfBirth | date:'d MMM y' }}</span>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn-outline" type="button" (click)="openPatient(p)">Apri</button>
                    </div>
                </li>
            </ul>
        </article>
    </section>

    <!-- Overlay -->
    <div class="page-loading-overlay" *ngIf="loadingAll" role="status" aria-live="polite" aria-busy="true">
        <span class="spinner spinner--big" aria-hidden="true"></span>
        <span class="sr-only">Caricamento dashboard‚Ä¶</span>
    </div>
</div>

<!-- Modale: Dettagli appuntamento -->
<div class="modal-overlay" *ngIf="appointmentDetailsVisible" (click)="closeAppointment()" role="dialog"
    aria-modal="true" aria-labelledby="appt-dialog-title">
    <div class="modal" (click)="$event.stopPropagation()" (keydown.escape)="closeAppointment()" tabindex="-1">
        <h3 id="appt-dialog-title">Dettagli appuntamento</h3>

        <div class="details" *ngIf="viewingAppointment as v">
            <div><strong>Paziente:</strong> {{ fmtPatientName(v) }}</div>
            <div><strong>Dottore:</strong> {{ fmtDoctorName(v) }}</div>
            <div><strong>Studio:</strong> {{ fmtStudioName(v) }}</div>

            <div><strong>Tipo:</strong> {{ v.kind || '‚Äî' }}</div>
            <div><strong>Stato:</strong> {{ v.status || '‚Äî' }}</div>

            <div><strong>Data:</strong> {{ v.startAt | date:'d MMMM y' }}</div>
            <div><strong>Orario:</strong> {{ v.startAt | date:'HH:mm' }} ‚Äì {{ v.endAt | date:'HH:mm' }}</div>

            <div><strong>Motivo:</strong> {{ v.reason || '‚Äî' }}</div>
            <div><strong>Note:</strong> {{ v.notes || '‚Äî' }}</div>

            <div *ngIf="v.result !== undefined">
                <div *ngIf="v.result !== undefined">
                    <strong>Esito:</strong>
                    <button class="btn-outline small" (click)="openResult()" aria-label="Apri esito appuntamento">
                        üìÑ Apri esito
                    </button>
                </div>
            </div>
            <button *ngIf="v?.id && (v.status === 'BOOKED' || v.status === 'CONFIRMED')" class="btn-success small"
                [routerLink]="['/evento-iniziato', v.id]" [state]="{ appt: v }" type="button">
                ‚ñ∂Ô∏è Inizia visita
            </button>

        </div>

        <div class="modal-actions">
            <button class="btn" #closeApptBtn (click)="closeAppointment()">Chiudi</button>
            <button class="btn-outline" type="button" routerLink="/calendar">Vai al calendario</button>
        </div>
    </div>
</div>

<!-- Modale: Esito appuntamento (testo lungo) -->
<div class="modal-overlay" *ngIf="resultVisible" (click)="closeResult()" role="dialog" aria-modal="true"
    aria-labelledby="result-dialog-title">
    <div class="modal large" (click)="$event.stopPropagation()" (keydown.escape)="closeResult()" tabindex="-1">
        <h3 id="result-dialog-title">Esito appuntamento</h3>
        <div class="result-text multiline">
            {{ viewingAppointment?.result || 'Nessun esito inserito.' }}
        </div>
        <div class="modal-actions">
            <button class="btn" (click)="closeResult()">Chiudi</button>
        </div>
    </div>
</div>
<!-- Modale: Dettagli paziente -->
<div class="modal-overlay" *ngIf="patientDetailsVisible" (click)="closePatient()" role="dialog" aria-modal="true"
    aria-labelledby="patient-dialog-title">

    <div class="modal" (click)="$event.stopPropagation()" (keydown.escape)="closePatient()" tabindex="-1">
        <h3 id="patient-dialog-title">Dettagli paziente</h3>

        <div class="details" *ngIf="viewingPatient as p">
            <div><strong>Nome:</strong> {{ (p.firstname || '') + ' ' + (p.lastname || '') || '‚Äî' }}</div>
            <div><strong>Email:</strong> {{ p.email || '‚Äî' }}</div>
            <div><strong>Telefono:</strong> {{ p.phone || '‚Äî' }}</div>
            <div><strong>SSN:</strong> {{ p.SSN || '‚Äî' }}</div>
            <div><strong>Data di nascita:</strong> {{ p.dateOfBirth ? (p.dateOfBirth | date:'d MMM y') : '‚Äî' }}</div>
            <!-- aggiungi altri campi se li hai -->
        </div>

        <div class="modal-actions">
            <button class="btn" #closePatientBtn (click)="closePatient()">Chiudi</button>
            <button class="btn-outline" type="button" routerLink="/patients">Vai ai pazienti</button>
        </div>
    </div>
</div>