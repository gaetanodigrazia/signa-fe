<div class="settings-page">

    <!-- Toolbar -->
    <header class="toolbar surface">
        <div class="left">
            <h2>Impostazioni</h2>
            <p class="subtitle">Preferenze utente e studio</p>
        </div>
        <div class="right" role="toolbar">
            <button class="btn btn-ghost" type="button" (click)="reset()">Annulla</button>
            <button class="btn btn-primary" type="button" [disabled]="form.pristine || form.invalid || saving"
                (click)="save()">
                ðŸ’¾ Salva
            </button>
        </div>
    </header>

    <!-- Tabbar -->
    <nav class="tabs" role="tablist" aria-label="Sezioni impostazioni">
        <button *ngFor="let t of tabs; let i = index" class="tab" role="tab" [attr.aria-selected]="currentTab === t.key"
            (click)="setTab(t.key)" type="button">
            <span class="tab__icon" aria-hidden="true">{{ t.icon }}</span>
            <span class="tab__label">{{ t.label }}</span>
            <span *ngIf="isTabDirty(t.key)" class="tab__dot" aria-hidden="true"></span>
        </button>

        <span class="tabs__indicator" [style.transform]="indicatorTransform"></span>
    </nav>

    <!-- Panels -->
    <form [formGroup]="form" class="panels">

        <!-- PROFILO -->
        <section class="panel surface" role="tabpanel" id="profile-panel" aria-labelledby="profile-tab"
            [hidden]="currentTab !== 'profile'">
            <header class="card-header">
                <h3 class="card__title">Profilo</h3>
            </header>

            <div class="grid">
                <label class="field">
                    <span>Nome</span>
                    <input type="text" formControlName="firstName" placeholder="Nome" />
                </label>

                <label class="field">
                    <span>Cognome</span>
                    <input type="text" formControlName="lastName" placeholder="Cognome" />
                </label>

                <label class="field">
                    <span>Titolo</span>
                    <input type="text" formControlName="title" placeholder="Dr., Dott.ssa, â€¦" />
                </label>

                <label class="field">
                    <span>Email</span>
                    <input type="email" formControlName="email" placeholder="nome@studio.it" />
                </label>

                <label class="field">
                    <span>Lingua</span>
                    <select formControlName="locale">
                        <option value="it-IT">Italiano</option>
                        <option value="en-GB">English (UK)</option>
                    </select>
                </label>

                <label class="field">
                    <span>Formato ora</span>
                    <select formControlName="timeFormat">
                        <option value="24h">24 ore</option>
                        <option value="12h">AM/PM</option>
                    </select>
                </label>
            </div>
        </section>

        <!-- Digitale -->
        <section class="panel surface" role="tabpanel" id="digitale-panel" aria-labelledby="digitale-tab"
            [hidden]="currentTab !== 'digitale'">
            <header class="card-header">
                <h3 class="card__title">Digitale</h3>
            </header>

            <div class="row-setting">
                <div class="row-text">
                    <strong>Promemoria automatici ai pazienti</strong>
                    <small>Invio promemoria 24h prima dellâ€™appuntamento</small>
                </div>
                <button type="button" class="toggle-btn" [class.on]="form.value.patientReminders"
                    [class.off]="!form.value.patientReminders" [attr.aria-pressed]="form.value.patientReminders"
                    (click)="onToggle('patientReminders')">
                    {{ form.value.patientReminders ? 'Abilitato' : 'Disabilitato' }}
                </button>
            </div>

            <label class="field mt">
                <span>Firma email</span>
                <textarea rows="3" formControlName="emailSignature"
                    placeholder="Cordiali saluti, Dr./Dott.ssa â€¦"></textarea>
            </label>

            <div class="row-setting">
                <div class="row-text"><strong>Portale paziente</strong></div>
                <button type="button" class="toggle-btn" [class.on]="form.value.allowPatientPortal"
                    [class.off]="!form.value.allowPatientPortal" [attr.aria-pressed]="form.value.allowPatientPortal"
                    (click)="onToggle('allowPatientPortal')">
                    {{ form.value.allowPatientPortal ? 'Abilitato' : 'Disabilitato' }}
                </button>
            </div>
        </section>

        <!-- AGENDA -->
        <section class="panel surface" role="tabpanel" id="agenda-panel" aria-labelledby="agenda-tab"
            [hidden]="currentTab !== 'agenda'">
            <header class="card-header">
                <h3 class="card__title">Agenda e disponibilitÃ </h3>
            </header>

            <div class="grid">
                <label class="field">
                    <span>Durata visita standard</span>
                    <select formControlName="slotDuration">
                        <option value="20">20 minuti</option>
                        <option value="30">30 minuti</option>
                        <option value="45">45 minuti</option>
                        <option value="60">60 minuti</option>
                    </select>
                </label>

                <label class="field">
                    <span>Buffer tra appuntamenti</span>
                    <select formControlName="slotBuffer">
                        <option value="0">Nessuno</option>
                        <option value="5">5 minuti</option>
                        <option value="10">10 minuti</option>
                        <option value="15">15 minuti</option>
                    </select>
                </label>

                <label class="field">
                    <span>Giorni lavorativi</span>
                    <select formControlName="workingDays" multiple size="5">
                        <option *ngFor="let d of days" [value]="d.value">{{ d.label }}</option>
                    </select>
                    <small class="hint">Ctrl/Cmd + click per selezione multipla</small>
                </label>
            </div>
        </section>

        <!-- STUDIO -->
        <section class="panel surface" role="tabpanel" id="clinic-panel" aria-labelledby="clinic-tab"
            [hidden]="currentTab !== 'clinic'">
            <header class="card-header">
                <h3 class="card__title">Studio e fatturazione</h3>
            </header>

            <div class="grid">
                <label class="field">
                    <span>Nome studio</span>
                    <input type="text" formControlName="clinicName" placeholder="Studio Medico â€¦" />
                </label>

                <label class="field">
                    <span>Telefono</span>
                    <input type="tel" formControlName="clinicPhone" placeholder="+39 â€¦" />
                </label>

                <label class="field">
                    <span>Indirizzo</span>
                    <input type="text" formControlName="clinicAddress" placeholder="Via, CittÃ " />
                </label>

                <label class="field">
                    <span>Partita IVA</span>
                    <input type="text" formControlName="vatId" placeholder="ITâ€¦" />
                </label>

                <label class="field">
                    <span>IBAN</span>
                    <input type="text" formControlName="iban" placeholder="IT00 A000 0000 0000 0000 0000 000" />
                </label>
            </div>
        </section>


        <!-- SICUREZZA -->
        <section class="panel surface" role="tabpanel" id="security-panel" aria-labelledby="security-tab"
            [hidden]="currentTab !== 'security'">
            <header class="card-header">
                <h3 class="card__title">Sicurezza</h3>
            </header>

            <!-- 2FA: apre modale configurazione -->
            <div class="row-setting">
                <div class="row-text">
                    <strong>Autenticazione a due fattori (2FA)</strong>
                    <small>Proteggi lâ€™accesso con codice via SMS o Email</small>
                </div>
                <button type="button" class="toggle-btn" [class.on]="form.value.enable2fa"
                    [class.off]="!form.value.enable2fa" [attr.aria-pressed]="form.value.enable2fa"
                    (click)="openTwofaModal()">
                    {{ form.value.enable2fa ? 'Configurata' : 'Disabilitata' }}
                </button>
            </div>

            <!-- Logout automatico: tempo + bottone stato -->
            <div class="row-setting">
                <div class="row-text">
                    <strong>Logout automatico</strong>
                    <small>Disconnessione dopo inattivitÃ </small>
                </div>
                <div class="row-actions">
                    <select class="logout-time" formControlName="autoLogoutMinutes"
                        [disabled]="!form.value.enableAutoLogout" aria-label="Tempo logout automatico">
                        <option *ngFor="let m of autoLogoutOptions" [ngValue]="m">{{ m }} min</option>
                    </select>

                    <button type="button" class="toggle-btn" [class.on]="form.value.enableAutoLogout"
                        [class.off]="!form.value.enableAutoLogout" [attr.aria-pressed]="form.value.enableAutoLogout"
                        (click)="onToggle('enableAutoLogout')">
                        {{ form.value.enableAutoLogout ? 'Abilitato' : 'Disabilitato' }}
                    </button>
                </div>
            </div>

            <div class="inline-actions">
                <button type="button" class="btn-outline" (click)="changePassword()">Cambia password</button>
                <button type="button" class="btn-outline" (click)="downloadActivityLog()">Scarica log attivitÃ </button>
            </div>
        </section>
    </form>
</div>

<!-- ============ MODALI ============ -->

<!-- Conferma disabilitazione -->
<div class="modal-overlay" *ngIf="confirm.state">
    <div class="modal small" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
        <h3 id="confirm-title">Confermi la disabilitazione?</h3>
        <p>Stai per disabilitare: <strong>{{ confirm.label }}</strong>.</p>
        <div class="modal-actions">
            <button class="btn btn-ghost" (click)="closeConfirm()">Annulla</button>
            <button class="btn btn-primary" (click)="confirmDisable()">Disabilita</button>
        </div>
    </div>
</div>

<!-- Impostazioni 2FA -->
<div class="modal-overlay" *ngIf="twofa.open">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="twofa-title">
        <h3 id="twofa-title">Imposta 2FA</h3>
        <p class="hint">Scegli il metodo e inserisci i recapiti.</p>

        <label class="field">
            <span>Metodo</span>
            <select [(ngModel)]="twofa.method">
                <option value="sms">SMS (telefono)</option>
                <option value="email">Email</option>
            </select>
        </label>

        <label class="field" *ngIf="twofa.method === 'sms'">
            <span>Telefono</span>
            <input type="tel" [(ngModel)]="twofa.phone" placeholder="+39 ..." />
        </label>

        <label class="field" *ngIf="twofa.method === 'email'">
            <span>Email</span>
            <input type="email" [(ngModel)]="twofa.email" placeholder="nome@studio.it" />
        </label>

        <div class="modal-actions">
            <button class="btn btn-ghost" (click)="closeTwofa()">Annulla</button>
            <button class="btn btn-primary" (click)="saveTwofa()">Salva</button>
        </div>
    </div>
</div>


<div class="modal-overlay" *ngIf="showLeaveModal">
    <div class="modal small">
        <h3>Modifiche non salvate</h3>
        <p>Hai modifiche non salvate. Vuoi davvero lasciare questa pagina?</p>
        <div class="modal-actions">
            <button type="button" class="btn btn-ghost" (click)="onLeaveCancel()">Rimani</button>
            <button type="button" class="btn btn-danger" (click)="onLeaveConfirm()">Esci senza salvare</button>
        </div>
    </div>
</div>